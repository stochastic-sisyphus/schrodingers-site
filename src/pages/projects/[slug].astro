---
/**
 * Individual project detail page
 */

import ContentLayout from '@/layouts/ContentLayout.astro';
import { fetchAllRepos, fetchRepoReadme, fetchRepoStructure, fetchRecentCommits } from '@/lib/github';
import { analyzeRepoStructure } from '@/lib/visualizations/code-analyzer';
import { analyzeCommitActivity } from '@/lib/visualizations/activity-analyzer';
import CodeGraph from '@/components/visualizations/CodeGraph.svelte';
import DependencyTree from '@/components/visualizations/DependencyTree.svelte';
import ContributorNetwork from '@/components/visualizations/ContributorNetwork.svelte';
import ActivityTimeline from '@/components/visualizations/ActivityTimeline.svelte';

export async function getStaticPaths() {
  const repos = await fetchAllRepos();

  return Promise.all(
    repos.map(async (repo) => {
      const readme = await fetchRepoReadme(repo.owner.login, repo.name);
      const fileStructure = await fetchRepoStructure(repo.owner.login, repo.name);
      const commits = await fetchRecentCommits(repo.owner.login, repo.name);

      // Analyze structure for visualizations
      const structureAnalysis = fileStructure.length > 0
        ? analyzeRepoStructure(fileStructure)
        : null;

      // Analyze commit activity
      const activityAnalysis = commits.length > 0
        ? analyzeCommitActivity(commits)
        : null;

      return {
        params: { slug: repo.name },
        props: {
          repo,
          readme,
          structureAnalysis,
          activityAnalysis,
          hasVisualizations: fileStructure.length > 0,
          hasActivity: commits.length > 0,
        },
      };
    })
  );
}

interface Props {
  repo: Awaited<ReturnType<typeof fetchAllRepos>>[0];
  readme: string | null;
  structureAnalysis: ReturnType<typeof analyzeRepoStructure> | null;
  activityAnalysis: ReturnType<typeof analyzeCommitActivity> | null;
  hasVisualizations: boolean;
  hasActivity: boolean;
}

const { repo, readme, structureAnalysis, activityAnalysis, hasVisualizations, hasActivity } = Astro.props;

const updatedDate = new Date(repo.updated_at).toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

// Prepare visualization data
const codeGraphData = structureAnalysis?.graph || { nodes: [], edges: [] };
const treeData = structureAnalysis?.tree || { name: 'root', children: [], path: '' };
const metrics = structureAnalysis?.metrics;

// Technology stack for contributor network (fallback when no contributors)
const techStack = repo.topics.length > 0
  ? repo.topics.map(topic => ({ name: topic, value: 10 }))
  : repo.language
  ? [{ name: repo.language, value: 100 }]
  : [];
---

<ContentLayout title={`${repo.name} | Projects | stochastic-sisyphus`} description={repo.description || undefined}>
  <article class="project-detail">
    <header class="project-header frosted-glass">
      <h1 class="project-name">{repo.name}</h1>

      {repo.description && (
        <p class="project-description">{repo.description}</p>
      )}

      <div class="project-meta">
        {repo.language && (
          <span class="language">
            <span class="language-dot"></span>
            {repo.language}
          </span>
        )}

        {repo.stargazers_count > 0 && (
          <span class="stars">★ {repo.stargazers_count}</span>
        )}

        {repo.forks_count > 0 && (
          <span class="forks">⑂ {repo.forks_count}</span>
        )}

        <time datetime={repo.updated_at}>Updated {updatedDate}</time>
      </div>

      {repo.topics.length > 0 && (
        <div class="project-topics">
          {repo.topics.map((topic) => (
            <span class="topic">{topic}</span>
          ))}
        </div>
      )}

      <div class="project-links">
        <a
          href={repo.html_url}
          class="project-link"
          target="_blank"
          rel="noopener noreferrer"
        >
          View on GitHub →
        </a>

        {repo.homepage && (
          <a
            href={repo.homepage}
            class="project-link"
            target="_blank"
            rel="noopener noreferrer"
          >
            Visit Website →
          </a>
        )}
      </div>
    </header>

    {hasVisualizations && structureAnalysis && (
      <>
        <section class="visualization-section">
          <h2 class="viz-section-title">Code Structure</h2>

          <div class="visualization-grid">
            {codeGraphData.nodes.length > 0 && (
              <div class="visualization-container frosted-glass">
                <h3>Dependency Graph</h3>
                <p class="viz-description">Interactive network showing file and directory relationships</p>
                <CodeGraph data={codeGraphData} client:visible />
              </div>
            )}

            {treeData.children && treeData.children.length > 0 && (
              <div class="visualization-container frosted-glass">
                <h3>File Hierarchy</h3>
                <p class="viz-description">Hierarchical tree of project structure</p>
                <DependencyTree data={treeData} client:visible />
              </div>
            )}
          </div>

          {metrics && metrics.languageDistribution.length > 0 && (
            <div class="visualization-container frosted-glass metrics-panel">
              <h3>Project Metrics</h3>
              <div class="metrics-grid">
                <div class="metric">
                  <div class="metric-value">{metrics.totalFiles}</div>
                  <div class="metric-label">Files</div>
                </div>
                <div class="metric">
                  <div class="metric-value">{(metrics.totalSize / 1024).toFixed(1)} KB</div>
                  <div class="metric-label">Total Size</div>
                </div>
                <div class="metric">
                  <div class="metric-value">{metrics.languageDistribution.length}</div>
                  <div class="metric-label">Languages</div>
                </div>
              </div>
              <div class="language-breakdown">
                {metrics.languageDistribution.slice(0, 5).map(lang => (
                  <div class="language-item">
                    <div class="language-name">{lang.language}</div>
                    <div class="language-bar">
                      <div class="language-fill" style={`width: ${lang.percentage}%`}></div>
                    </div>
                    <div class="language-percent">{lang.percentage.toFixed(1)}%</div>
                  </div>
                ))}
              </div>
            </div>
          )}

          {techStack.length > 0 && (
            <div class="visualization-container frosted-glass">
              <h3>Technology Stack</h3>
              <p class="viz-description">Technologies and tools used in this project</p>
              <ContributorNetwork data={techStack} type="technologies" client:visible />
            </div>
          )}
        </section>
      </>
    )}

    {hasActivity && activityAnalysis && activityAnalysis.timeline.length > 0 && (
      <section class="visualization-section">
        <h2 class="viz-section-title">Development Activity</h2>
        <div class="visualization-container frosted-glass">
          <h3>Commit Timeline</h3>
          <p class="viz-description">Development activity over time showing commit frequency and patterns</p>
          <ActivityTimeline data={activityAnalysis.timeline} client:visible />
        </div>

        {activityAnalysis.mostActiveDay && (
          <div class="activity-stats frosted-glass">
            <div class="stat-item">
              <span class="stat-label">Total Commits</span>
              <span class="stat-value">{activityAnalysis.totalCommits}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Most Active Day</span>
              <span class="stat-value">{activityAnalysis.mostActiveDay.date.toLocaleDateString()}</span>
              <span class="stat-detail">{activityAnalysis.mostActiveDay.count} commits</span>
            </div>
            {activityAnalysis.dateRange && (
              <div class="stat-item">
                <span class="stat-label">Active Period</span>
                <span class="stat-value">{activityAnalysis.dateRange.days} days</span>
              </div>
            )}
          </div>
        )}
      </section>
    )}

    {readme && (
      <section class="readme-section frosted-glass">
        <h2>README</h2>
        <div class="readme-content" set:html={readme} />
      </section>
    )}

    <footer class="project-footer">
      <a href="/projects" class="back-link">← Back to all projects</a>
    </footer>
  </article>
</ContentLayout>

<style>
  .project-detail {
    max-width: 900px;
    margin: 0 auto;
  }

  .project-header {
    background: rgba(68, 88, 104, 0.1);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(166, 182, 194, 0.2);
    border-radius: 12px;
    padding: 3rem;
    margin-bottom: 2rem;
  }

  .project-name {
    font-family: 'JetBrains Mono', monospace;
    font-size: clamp(32px, 5vw, 48px);
    font-weight: 500;
    color: var(--highlight);
    margin: 0 0 1rem 0;
    word-break: break-word;
  }

  .project-description {
    font-size: 1.125rem;
    color: var(--light);
    line-height: 1.6;
    margin: 0 0 1.5rem 0;
  }

  .project-meta {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 1.5rem;
    font-size: 0.9375rem;
    color: var(--accent);
    margin-bottom: 1.5rem;
  }

  .language {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .language-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: var(--accent);
  }

  .project-topics {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
  }

  .topic {
    padding: 0.25rem 0.75rem;
    background: rgba(166, 182, 194, 0.1);
    border-radius: 4px;
    font-size: 0.75rem;
    color: var(--accent);
  }

  .project-links {
    display: flex;
    gap: 1.5rem;
  }

  .project-link {
    color: var(--accent);
    text-decoration: none;
    font-size: 1rem;
    transition: color 0.2s ease;
  }

  .project-link:hover {
    color: var(--highlight);
  }

  .readme-section {
    background: rgba(68, 88, 104, 0.1);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(166, 182, 194, 0.2);
    border-radius: 12px;
    padding: 3rem;
    margin-bottom: 2rem;
  }

  .readme-section h2 {
    font-family: 'Cormorant Garamond', serif;
    font-size: 2rem;
    font-weight: 500;
    color: var(--highlight);
    margin: 0 0 2rem 0;
  }

  .readme-content {
    color: var(--light);
    line-height: 1.8;
  }

  .readme-content :global(h1),
  .readme-content :global(h2),
  .readme-content :global(h3) {
    font-family: 'Cormorant Garamond', serif;
    color: var(--highlight);
    margin: 2rem 0 1rem;
  }

  .readme-content :global(code) {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.9em;
    background: rgba(166, 182, 194, 0.1);
    padding: 0.2em 0.4em;
    border-radius: 3px;
  }

  .readme-content :global(pre) {
    background: rgba(20, 26, 32, 0.6);
    border: 1px solid rgba(166, 182, 194, 0.2);
    border-radius: 8px;
    padding: 1.5rem;
    overflow-x: auto;
  }

  .readme-content :global(a) {
    color: var(--accent);
    transition: color 0.2s ease;
  }

  .readme-content :global(a:hover) {
    color: var(--highlight);
  }

  .project-footer {
    margin: 2rem 0;
  }

  .back-link {
    color: var(--accent);
    text-decoration: none;
    font-size: 0.9375rem;
    transition: color 0.2s ease;
  }

  .back-link:hover {
    color: var(--highlight);
  }

  /* Visualization Styles */
  .visualization-section {
    margin: 3rem 0;
  }

  .viz-section-title {
    font-family: 'Cormorant Garamond', serif;
    font-size: 2.5rem;
    font-weight: 500;
    color: var(--highlight);
    margin: 0 0 2rem 0;
    text-align: center;
  }

  .visualization-grid {
    display: grid;
    gap: 2rem;
    margin-bottom: 2rem;
  }

  .visualization-container {
    background: rgba(68, 88, 104, 0.1);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(166, 182, 194, 0.2);
    border-radius: 12px;
    padding: 2rem;
    transition: all 0.3s ease;
  }

  .visualization-container:hover {
    border-color: rgba(166, 182, 194, 0.4);
    box-shadow: 0 8px 32px rgba(20, 26, 32, 0.3);
  }

  .visualization-container h3 {
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.75rem;
    color: var(--highlight);
    margin: 0 0 0.5rem 0;
  }

  .viz-description {
    font-size: 0.9375rem;
    color: var(--accent);
    margin: 0 0 1.5rem 0;
    line-height: 1.5;
  }

  /* Metrics Panel */
  .metrics-panel {
    margin-bottom: 2rem;
  }

  .metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 2rem;
    margin-bottom: 2rem;
  }

  .metric {
    text-align: center;
  }

  .metric-value {
    font-size: 2.5rem;
    font-weight: 600;
    color: var(--highlight);
    font-family: 'JetBrains Mono', monospace;
    line-height: 1;
  }

  .metric-label {
    font-size: 0.875rem;
    color: var(--accent);
    margin-top: 0.5rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .language-breakdown {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin-top: 1.5rem;
  }

  .language-item {
    display: grid;
    grid-template-columns: 120px 1fr 60px;
    align-items: center;
    gap: 1rem;
  }

  .language-name {
    font-size: 0.9375rem;
    color: var(--light);
    font-family: 'JetBrains Mono', monospace;
  }

  .language-bar {
    height: 8px;
    background: rgba(68, 88, 104, 0.3);
    border-radius: 4px;
    overflow: hidden;
  }

  .language-fill {
    height: 100%;
    background: linear-gradient(90deg, #8498a6, #627888);
    border-radius: 4px;
    transition: width 0.5s ease;
  }

  .language-percent {
    font-size: 0.875rem;
    color: var(--accent);
    text-align: right;
    font-family: 'JetBrains Mono', monospace;
  }

  /* Activity Stats */
  .activity-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 2rem;
    margin-top: 2rem;
    padding: 2rem;
  }

  .stat-item {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .stat-label {
    font-size: 0.875rem;
    color: var(--accent);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .stat-value {
    font-size: 2rem;
    font-weight: 600;
    color: var(--highlight);
    font-family: 'JetBrains Mono', monospace;
  }

  .stat-detail {
    font-size: 0.875rem;
    color: var(--light);
  }

  @media (max-width: 768px) {
    .project-header,
    .readme-section,
    .visualization-container {
      padding: 2rem 1.5rem;
    }

    .viz-section-title {
      font-size: 2rem;
    }

    .metrics-grid {
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 1.5rem;
    }

    .metric-value {
      font-size: 2rem;
    }

    .language-item {
      grid-template-columns: 100px 1fr 50px;
      gap: 0.75rem;
    }

    .language-name {
      font-size: 0.875rem;
    }

    .activity-stats {
      grid-template-columns: 1fr;
      gap: 1.5rem;
    }

    .stat-value {
      font-size: 1.75rem;
    }
  }
</style>
