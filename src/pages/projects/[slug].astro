---
/**
 * Individual project detail page
 */

import ContentLayout from '@/layouts/ContentLayout.astro';
import { fetchAllRepos, fetchRepoReadme, fetchRepoStructure, fetchRecentCommits } from '@/lib/github';
import { analyzeRepoStructure } from '@/lib/visualizations/code-analyzer';
import { analyzeCommitActivity } from '@/lib/visualizations/activity-analyzer';
import CodeGraph from '@/components/visualizations/CodeGraph.svelte';
import DependencyTree from '@/components/visualizations/DependencyTree.svelte';
import ContributorNetwork from '@/components/visualizations/ContributorNetwork.svelte';
import ActivityTimeline from '@/components/visualizations/ActivityTimeline.svelte';

export async function getStaticPaths() {
  const repos = await fetchAllRepos();

  return Promise.all(
    repos.map(async (repo) => {
      const readme = await fetchRepoReadme(repo.owner.login, repo.name);
      const fileStructure = await fetchRepoStructure(repo.owner.login, repo.name);
      const commits = await fetchRecentCommits(repo.owner.login, repo.name);

      // Analyze structure for visualizations
      const structureAnalysis = fileStructure.length > 0
        ? analyzeRepoStructure(fileStructure)
        : null;

      // Analyze commit activity
      const activityAnalysis = commits.length > 0
        ? analyzeCommitActivity(commits)
        : null;

      return {
        params: { slug: repo.name },
        props: {
          repo,
          readme,
          structureAnalysis,
          activityAnalysis,
          hasVisualizations: fileStructure.length > 0,
          hasActivity: commits.length > 0,
        },
      };
    })
  );
}

interface Props {
  repo: Awaited<ReturnType<typeof fetchAllRepos>>[0];
  readme: string | null;
  structureAnalysis: ReturnType<typeof analyzeRepoStructure> | null;
  activityAnalysis: ReturnType<typeof analyzeCommitActivity> | null;
  hasVisualizations: boolean;
  hasActivity: boolean;
}

const { repo, readme, structureAnalysis, activityAnalysis, hasVisualizations, hasActivity } = Astro.props;

const updatedDate = new Date(repo.updated_at).toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

// Prepare visualization data
const codeGraphData = structureAnalysis?.graph || { nodes: [], edges: [] };
const treeData = structureAnalysis?.tree || { name: 'root', children: [], path: '' };
const metrics = structureAnalysis?.metrics;

// Technology stack for contributor network (fallback when no contributors)
const techStack = repo.topics.length > 0
  ? repo.topics.map(topic => ({ name: topic, value: 10 }))
  : repo.language
  ? [{ name: repo.language, value: 100 }]
  : [];
---

<ContentLayout title={`${repo.name} | Projects | stochastic-sisyphus`} description={repo.description || undefined}>
  <article class="project-detail">
    <!-- Atmospheric header with glow -->
    <header class="project-header">
      <div class="header-glow" aria-hidden="true"></div>

      <div class="header-content">
        <h1 class="project-name">{repo.name}</h1>

        {repo.description && (
          <p class="project-description">{repo.description}</p>
        )}

        <div class="project-meta">
          {repo.language && (
            <span class="language">
              <span class="language-dot"></span>
              {repo.language}
            </span>
          )}

          {repo.stargazers_count > 0 && (
            <span class="stars">★ {repo.stargazers_count}</span>
          )}

          {repo.forks_count > 0 && (
            <span class="forks">⑂ {repo.forks_count}</span>
          )}

          <time datetime={repo.updated_at}>Updated {updatedDate}</time>
        </div>

        {repo.topics.length > 0 && (
          <div class="project-topics">
            {repo.topics.map((topic) => (
              <span class="topic">{topic}</span>
            ))}
          </div>
        )}

        <div class="project-links">
          <a
            href={repo.html_url}
            class="project-link"
            target="_blank"
            rel="noopener noreferrer"
          >
            View on GitHub →
          </a>

          {repo.homepage && (
            <a
              href={repo.homepage}
              class="project-link"
              target="_blank"
              rel="noopener noreferrer"
            >
              Visit Website →
            </a>
          )}
        </div>
      </div>
    </header>

    {hasVisualizations && structureAnalysis && (
      <>
        <section class="visualization-section float-in">
          <div class="section-header">
            <h2 class="viz-section-title">Code Structure</h2>
            <span class="section-badge">analysis</span>
          </div>

          <div class="visualization-grid">
            {codeGraphData.nodes.length > 0 && (
              <div class="visualization-container">
                <div class="viz-header">
                  <h3>Dependency Graph</h3>
                  <p class="viz-description">Interactive network showing file and directory relationships</p>
                </div>
                <CodeGraph data={codeGraphData} client:visible />
              </div>
            )}

            {treeData.children && treeData.children.length > 0 && (
              <div class="visualization-container">
                <div class="viz-header">
                  <h3>File Hierarchy</h3>
                  <p class="viz-description">Hierarchical tree of project structure</p>
                </div>
                <DependencyTree data={treeData} client:visible />
              </div>
            )}
          </div>

          {metrics && metrics.languageDistribution.length > 0 && (
            <div class="visualization-container metrics-panel">
              <div class="viz-header">
                <h3>Project Metrics</h3>
              </div>
              <div class="metrics-grid">
                <div class="metric">
                  <div class="metric-value">{metrics.totalFiles}</div>
                  <div class="metric-label">Files</div>
                </div>
                <div class="metric">
                  <div class="metric-value">{(metrics.totalSize / 1024).toFixed(1)} KB</div>
                  <div class="metric-label">Total Size</div>
                </div>
                <div class="metric">
                  <div class="metric-value">{metrics.languageDistribution.length}</div>
                  <div class="metric-label">Languages</div>
                </div>
              </div>
              <div class="language-breakdown">
                {metrics.languageDistribution.slice(0, 5).map(lang => (
                  <div class="language-item">
                    <div class="language-name">{lang.language}</div>
                    <div class="language-bar">
                      <div class="language-fill" style={`width: ${lang.percentage}%`}></div>
                    </div>
                    <div class="language-percent">{lang.percentage.toFixed(1)}%</div>
                  </div>
                ))}
              </div>
            </div>
          )}

          {techStack.length > 0 && (
            <div class="visualization-container">
              <div class="viz-header">
                <h3>Technology Stack</h3>
                <p class="viz-description">Technologies and tools used in this project</p>
              </div>
              <ContributorNetwork data={techStack} type="technologies" client:visible />
            </div>
          )}
        </section>
      </>
    )}

    {hasActivity && activityAnalysis && activityAnalysis.timeline.length > 0 && (
      <section class="visualization-section float-in">
        <div class="section-header">
          <h2 class="viz-section-title">Development Activity</h2>
          <span class="section-badge">timeline</span>
        </div>

        <div class="visualization-container">
          <div class="viz-header">
            <h3>Commit Timeline</h3>
            <p class="viz-description">Development activity over time showing commit frequency and patterns</p>
          </div>
          <ActivityTimeline data={activityAnalysis.timeline} client:visible />
        </div>

        {activityAnalysis.mostActiveDay && (
          <div class="activity-stats">
            <div class="stat-item">
              <span class="stat-label">Total Commits</span>
              <span class="stat-value">{activityAnalysis.totalCommits}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Most Active Day</span>
              <span class="stat-value">{activityAnalysis.mostActiveDay.date.toLocaleDateString()}</span>
              <span class="stat-detail">{activityAnalysis.mostActiveDay.count} commits</span>
            </div>
            {activityAnalysis.dateRange && (
              <div class="stat-item">
                <span class="stat-label">Active Period</span>
                <span class="stat-value">{activityAnalysis.dateRange.days} days</span>
              </div>
            )}
          </div>
        )}
      </section>
    )}

    {readme && (
      <section class="readme-section float-in">
        <div class="readme-header">
          <h2>README</h2>
          <span class="section-badge">documentation</span>
        </div>
        <div class="readme-content" set:html={readme} />
      </section>
    )}

    <footer class="project-footer">
      <a href="/projects" class="back-link">← Back to all projects</a>
    </footer>
  </article>
</ContentLayout>

<script>
  import { initScrollAnimations } from '@/lib/scroll-animations';

  // Initialize scroll-based atmospheric reveals
  document.addEventListener('DOMContentLoaded', () => {
    initScrollAnimations('.float-in');
  });
</script>

<style>
  .project-detail {
    max-width: 1100px;
    margin: 0 auto;
    position: relative;
  }

  /* Header - atmospheric with glow */
  .project-header {
    position: relative;
    margin-bottom: 5rem;
    padding: 4rem 0 3rem;
    border-bottom: 1px solid rgba(166, 182, 194, 0.08);
  }

  .header-glow {
    position: absolute;
    top: -80px;
    left: 10%;
    width: 500px;
    height: 250px;
    background: radial-gradient(
      ellipse,
      rgba(166, 182, 194, 0.18) 0%,
      rgba(132, 152, 166, 0.1) 40%,
      transparent 70%
    );
    filter: blur(60px);
    pointer-events: none;
    opacity: 0.9;
    animation: pulseGlow 8s ease-in-out infinite;
  }

  @keyframes pulseGlow {
    0%, 100% {
      opacity: 0.7;
      transform: scale(1);
    }
    50% {
      opacity: 1;
      transform: scale(1.15);
    }
  }

  .header-content {
    position: relative;
    z-index: 1;
  }

  .project-name {
    font-family: 'JetBrains Mono', monospace;
    font-size: clamp(2rem, 5vw, 3.5rem);
    font-weight: 700;
    color: var(--text-heading);
    margin: 0 0 1.5rem 0;
    word-break: break-word;
    letter-spacing: -0.02em;
    line-height: 1.2;
    text-shadow:
      0 2px 12px rgba(0, 0, 0, 0.5),
      0 4px 24px rgba(166, 182, 194, 0.15);
  }

  .project-description {
    font-size: clamp(1rem, 2vw, 1.25rem);
    color: var(--text-body);
    line-height: 1.6;
    margin: 0 0 2rem 0;
    opacity: 0.9;
  }

  .project-meta {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 1.5rem;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.875rem;
    color: var(--accent);
    margin-bottom: 2rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid rgba(166, 182, 194, 0.1);
  }

  .language {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .language-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--highlight);
    box-shadow: 0 0 6px rgba(166, 182, 194, 0.5);
  }

  .project-topics {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 2rem;
  }

  .topic {
    padding: 0.4rem 0.875rem;
    background: rgba(42, 56, 68, 0.6);
    border: 1px solid rgba(166, 182, 194, 0.2);
    border-radius: 6px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.75rem;
    color: var(--accent);
    font-weight: 500;
    letter-spacing: 0.02em;
  }

  .project-links {
    display: flex;
    gap: 1.5rem;
    flex-wrap: wrap;
  }

  .project-link {
    padding: 0.875rem 1.5rem;
    background: rgba(42, 56, 68, 0.7);
    border: 1px solid rgba(166, 182, 194, 0.25);
    border-radius: 8px;
    color: var(--text-body);
    text-decoration: none;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.875rem;
    font-weight: 500;
    transition: all var(--duration-short) var(--ease-smooth);
  }

  .project-link:hover {
    background: rgba(42, 56, 68, 0.9);
    border-color: rgba(166, 182, 194, 0.4);
    color: var(--text-heading);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  }

  /* Visualization Sections */
  .visualization-section {
    margin: 5rem 0;
    position: relative;
  }

  .section-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 3rem;
  }

  .viz-section-title {
    font-family: 'Cormorant Garamond', serif;
    font-size: clamp(2rem, 4vw, 3rem);
    font-weight: 400;
    color: var(--text-heading);
    margin: 0;
    letter-spacing: 0.02em;
    line-height: 1.2;
  }

  .section-badge {
    padding: 0.35rem 0.875rem;
    background: rgba(166, 182, 194, 0.1);
    border: 1px solid rgba(166, 182, 194, 0.2);
    border-radius: 6px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.6875rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--accent);
    font-weight: 500;
  }

  .visualization-grid {
    display: grid;
    gap: 2.5rem;
    margin-bottom: 2rem;
  }

  .visualization-container {
    background: rgba(42, 56, 68, 0.8);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(166, 182, 194, 0.2);
    border-radius: 12px;
    padding: 2.5rem;
    transition: all var(--duration-short) var(--ease-smooth);
    overflow: visible;
    box-shadow:
      0 4px 16px rgba(0, 0, 0, 0.15),
      0 0 0 1px rgba(166, 182, 194, 0.05) inset;
  }

  .visualization-container:hover {
    border-color: rgba(166, 182, 194, 0.35);
    box-shadow:
      0 8px 32px rgba(0, 0, 0, 0.25),
      0 0 24px rgba(166, 182, 194, 0.08),
      0 0 0 1px rgba(166, 182, 194, 0.1) inset;
  }

  .viz-header {
    margin-bottom: 2rem;
  }

  .visualization-container h3 {
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.75rem;
    color: var(--text-heading);
    margin: 0 0 0.5rem 0;
    font-weight: 500;
  }

  .viz-description {
    font-size: 0.9375rem;
    color: var(--text-body);
    margin: 0;
    line-height: 1.5;
    opacity: 0.85;
  }

  /* Metrics Panel */
  .metrics-panel {
    margin-bottom: 2rem;
  }

  .metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 2.5rem;
    margin-bottom: 2.5rem;
    padding: 2rem 0;
  }

  .metric {
    text-align: center;
  }

  .metric-value {
    font-size: 2.75rem;
    font-weight: 700;
    color: var(--text-heading);
    font-family: 'JetBrains Mono', monospace;
    line-height: 1;
    text-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
  }

  .metric-label {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.75rem;
    color: var(--accent);
    margin-top: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-weight: 600;
  }

  .language-breakdown {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
    margin-top: 2rem;
  }

  .language-item {
    display: grid;
    grid-template-columns: 130px 1fr 70px;
    align-items: center;
    gap: 1.25rem;
  }

  .language-name {
    font-size: 0.875rem;
    color: var(--text-body);
    font-family: 'JetBrains Mono', monospace;
    font-weight: 500;
  }

  .language-bar {
    height: 10px;
    background: rgba(20, 26, 32, 0.6);
    border-radius: 5px;
    overflow: hidden;
    border: 1px solid rgba(166, 182, 194, 0.1);
  }

  .language-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--highlight), var(--accent));
    border-radius: 5px;
    transition: width 0.8s var(--ease-smooth);
    box-shadow: 0 0 8px rgba(166, 182, 194, 0.3);
  }

  .language-percent {
    font-size: 0.8125rem;
    color: var(--accent);
    text-align: right;
    font-family: 'JetBrains Mono', monospace;
    font-weight: 600;
  }

  /* Activity Stats */
  .activity-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 2.5rem;
    margin-top: 2.5rem;
    padding: 2.5rem;
    background: rgba(20, 26, 32, 0.4);
    border-radius: 12px;
    border: 1px solid rgba(166, 182, 194, 0.1);
  }

  .stat-item {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .stat-label {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.75rem;
    color: var(--accent);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-weight: 600;
  }

  .stat-value {
    font-size: 2.25rem;
    font-weight: 700;
    color: var(--text-heading);
    font-family: 'JetBrains Mono', monospace;
    line-height: 1;
    text-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
  }

  .stat-detail {
    font-size: 0.875rem;
    color: var(--text-body);
    opacity: 0.85;
  }

  /* README Section */
  .readme-section {
    background: rgba(42, 56, 68, 0.7);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(166, 182, 194, 0.2);
    border-radius: 12px;
    padding: 3rem;
    margin: 5rem 0;
    box-shadow:
      0 4px 16px rgba(0, 0, 0, 0.15),
      0 0 0 1px rgba(166, 182, 194, 0.05) inset;
  }

  .readme-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 2.5rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid rgba(166, 182, 194, 0.1);
  }

  .readme-section h2 {
    font-family: 'Cormorant Garamond', serif;
    font-size: 2.25rem;
    font-weight: 500;
    color: var(--text-heading);
    margin: 0;
  }

  .readme-content {
    color: var(--text-body);
    line-height: 1.8;
  }

  .readme-content h1,
  .readme-content h2,
  .readme-content h3,
  .readme-content h4,
  .readme-content h5,
  .readme-content h6 {
    font-family: 'Cormorant Garamond', serif;
    color: var(--text-heading);
    margin: 2.5rem 0 1.25rem;
    line-height: 1.3;
  }

  .readme-content h1 { font-size: 2rem; }
  .readme-content h2 { font-size: 1.75rem; }
  .readme-content h3 { font-size: 1.5rem; }

  .readme-content p {
    margin-bottom: 1.25rem;
  }

  .readme-content ul,
  .readme-content ol {
    margin-bottom: 1.25rem;
    padding-left: 2rem;
  }

  .readme-content li {
    margin-bottom: 0.75rem;
  }

  .readme-content code {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.875em;
    background: rgba(20, 26, 32, 0.8);
    padding: 0.25em 0.5em;
    border-radius: 4px;
    color: var(--highlight);
    border: 1px solid rgba(166, 182, 194, 0.15);
  }

  .readme-content pre {
    background: rgba(20, 26, 32, 0.95);
    border: 1px solid rgba(166, 182, 194, 0.2);
    border-radius: 8px;
    padding: 1.5rem;
    overflow-x: auto;
    margin-bottom: 1.5rem;
  }

  .readme-content pre code {
    background: none;
    padding: 0;
    border: none;
    color: var(--text-body);
  }

  .readme-content a {
    color: var(--highlight);
    transition: color var(--duration-short) var(--ease-smooth);
    text-decoration: underline;
    text-decoration-color: rgba(166, 182, 194, 0.3);
  }

  .readme-content a:hover {
    color: var(--text-heading);
    text-decoration-color: rgba(166, 182, 194, 0.6);
  }

  .readme-content blockquote {
    border-left: 3px solid var(--accent);
    padding-left: 1.5rem;
    margin: 2rem 0;
    font-style: italic;
    opacity: 0.9;
    color: var(--text-body);
  }

  /* Footer */
  .project-footer {
    margin: 4rem 0 2rem;
    padding-top: 2rem;
    border-top: 1px solid rgba(166, 182, 194, 0.08);
  }

  .back-link {
    display: inline-flex;
    align-items: center;
    padding: 0.875rem 1.5rem;
    background: rgba(42, 56, 68, 0.6);
    border: 1px solid rgba(166, 182, 194, 0.2);
    border-radius: 8px;
    color: var(--text-body);
    text-decoration: none;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.875rem;
    font-weight: 500;
    transition: all var(--duration-short) var(--ease-smooth);
  }

  .back-link:hover {
    background: rgba(42, 56, 68, 0.8);
    border-color: rgba(166, 182, 194, 0.35);
    color: var(--text-heading);
    transform: translateX(-4px);
  }

  /* Scroll-based reveal */
  .float-in {
    opacity: 0;
    transform: translateY(40px);
    filter: blur(8px);
    transition: opacity 0.8s var(--ease-smooth),
                transform 0.8s var(--ease-smooth),
                filter 0.8s var(--ease-smooth);
  }

  .float-in.is-visible {
    opacity: 1;
    transform: translateY(0);
    filter: blur(0);
  }

  /* Responsive */
  @media (max-width: 1024px) {
    .project-header {
      padding: 3rem 0 2.5rem;
      margin-bottom: 4rem;
    }

    .header-glow {
      width: 350px;
      height: 180px;
    }
  }

  @media (max-width: 768px) {
    .project-header {
      padding: 2rem 0;
      margin-bottom: 3rem;
    }

    .header-glow {
      width: 250px;
      height: 120px;
      top: -50px;
    }

    .readme-section,
    .visualization-container {
      padding: 2rem 1.5rem;
    }

    .viz-section-title {
      font-size: 2rem;
    }

    .metrics-grid {
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 2rem;
    }

    .metric-value {
      font-size: 2.25rem;
    }

    .language-item {
      grid-template-columns: 100px 1fr 60px;
      gap: 1rem;
    }

    .language-name {
      font-size: 0.8125rem;
    }

    .activity-stats {
      grid-template-columns: 1fr;
      gap: 2rem;
      padding: 2rem;
    }

    .stat-value {
      font-size: 2rem;
    }

    .section-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.75rem;
    }
  }

  /* Reduce motion for accessibility */
  @media (prefers-reduced-motion: reduce) {
    .header-glow {
      animation: none;
      opacity: 0.7;
    }

    .float-in {
      transition: none;
    }

    .language-fill {
      transition: none;
    }
  }
</style>
