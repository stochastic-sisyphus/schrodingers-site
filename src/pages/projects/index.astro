---
/**
 * Projects directory - from content collection
 */

import { getCollection } from 'astro:content';
import ContentLayout from '@/layouts/ContentLayout.astro';
import ProjectCard from '@/components/ProjectCard.astro';
import Footer from '@/components/Footer.astro';
import SEO from '@/components/SEO.astro';
import Navigation from '@/components/Navigation.astro';

// Get all projects from content collection
const allProjects = await getCollection('projects');

// Sort projects by featured status first, then alphabetically
const projects = allProjects.sort((a, b) => {
  if (a.data.featured && !b.data.featured) return -1;
  if (!a.data.featured && b.data.featured) return 1;
  return a.data.name.localeCompare(b.data.name);
});

const featuredProjects = projects.filter(p => p.data.featured);

// Extract all unique languages and topics for filtering
const allLanguages = [...new Set(projects.map(p => p.data.language).filter(Boolean))].sort();
const allTopics = [...new Set(projects.flatMap(p => p.data.tags))].sort();
---

<ContentLayout
  title="Projects | stochastic-sisyphus"
  description="Explorations in code, data, and emergent systems. A collection of computational experiments and tools across machine learning, data science, and systems engineering."
>
  <SEO
    slot="head"
    title="Projects"
    description="Code projects and research tools"
    canonical={Astro.url.href}
  />

  <Navigation />

  <article class="projects-page">
    <!-- Header with atmospheric depth -->
    <header class="page-header">
      <div class="header-glow" aria-hidden="true"></div>
      <h1 class="page-title">projects</h1>
      <p class="page-subtitle">
        Computational experiments & emergent systems
      </p>
      <div class="header-meta">
        <span class="repo-count" id="repo-count">{projects.length} projects</span>
        <span class="data-source">content collection</span>
      </div>

      <!-- Atmospheric filter controls -->
      <div class="filter-controls" id="filter-controls">
        <input
          type="search"
          id="search-input"
          placeholder="Filter by name or topic..."
          class="search-input"
          aria-label="Search projects"
        />

        <select id="language-filter" class="filter-select" aria-label="Filter by language">
          <option value="">All Languages</option>
          {allLanguages.map(lang => (
            <option value={lang}>{lang}</option>
          ))}
        </select>

        <select id="topic-filter" class="filter-select" aria-label="Filter by topic">
          <option value="">All Topics</option>
          {allTopics.map(topic => (
            <option value={topic}>{topic}</option>
          ))}
        </select>

        <button id="reset-filters" class="reset-button" aria-label="Reset all filters">
          Reset
        </button>
      </div>
    </header>

    <!-- Featured projects with staggered reveal -->
    {featuredProjects.length > 0 && (
      <section class="featured-section float-in" id="featured-section">
        <div class="section-header">
          <h2 class="section-title">featured work</h2>
          <span class="section-badge">curated</span>
        </div>

        <div class="projects-grid featured-grid" id="featured-grid">
          {featuredProjects.map((project, index) => (
            <div class="grid-item" style={`animation-delay: ${index * 0.1}s`}>
              <ProjectCard project={project} />
            </div>
          ))}
        </div>
      </section>
    )}

    <!-- All projects with staggered reveal -->
    <section class="all-projects-section float-in">
      <div class="section-header">
        <h2 class="section-title">all projects</h2>
        <span class="section-badge" id="active-count">active</span>
      </div>

      <div class="projects-grid" id="projects-grid">
        {projects.map((project, index) => (
          <div class="grid-item" style={`animation-delay: ${(index % 12) * 0.08}s`}>
            <ProjectCard project={project} />
          </div>
        ))}
      </div>

      <div id="no-results" class="no-results" style="display: none;">
        <p>No projects match your filters</p>
        <button id="clear-filters-link" class="reset-link">Clear filters and show all</button>
      </div>
    </section>
  </article>

  <Footer slot="footer" />
</ContentLayout>

<script>
  // Atmospheric reveal & filtering
  import { initScrollAnimations } from '@/lib/scroll-animations';

  document.addEventListener('DOMContentLoaded', () => {
    // Initialize scroll-based reveals
    initScrollAnimations('.float-in');

    // Filter functionality
    const searchInput = document.getElementById('search-input') as HTMLInputElement;
    const languageFilter = document.getElementById('language-filter') as HTMLSelectElement;
    const topicFilter = document.getElementById('topic-filter') as HTMLSelectElement;
    const resetButton = document.getElementById('reset-filters') as HTMLButtonElement;
    const clearFiltersLink = document.getElementById('clear-filters-link') as HTMLButtonElement;
    const projectsGrid = document.getElementById('projects-grid');
    const noResults = document.getElementById('no-results');
    const repoCount = document.getElementById('repo-count');
    const activeCount = document.getElementById('active-count');

    function filterProjects() {
      const searchTerm = searchInput?.value.toLowerCase() || '';
      const selectedLanguage = languageFilter?.value || '';
      const selectedTopic = topicFilter?.value || '';

      const gridItems = projectsGrid?.querySelectorAll('.grid-item') || [];
      let visibleCount = 0;

      gridItems.forEach((item) => {
        const card = item.querySelector('.project-card');
        if (!card) return;

        const name = card.querySelector('.project-name')?.textContent?.toLowerCase() || '';
        const description = card.querySelector('.project-description')?.textContent?.toLowerCase() || '';
        const language = card.querySelector('.language')?.textContent?.trim() || '';
        const topics = Array.from(card.querySelectorAll('.topic')).map(t => t.textContent?.toLowerCase() || '');

        const matchesSearch = searchTerm === '' ||
          name.includes(searchTerm) ||
          description.includes(searchTerm) ||
          topics.some(t => t.includes(searchTerm));

        const matchesLanguage = selectedLanguage === '' || language === selectedLanguage;
        const matchesTopic = selectedTopic === '' || topics.includes(selectedTopic.toLowerCase());

        if (matchesSearch && matchesLanguage && matchesTopic) {
          (item as HTMLElement).style.display = '';
          visibleCount++;
        } else {
          (item as HTMLElement).style.display = 'none';
        }
      });

      // Update count and no-results message
      if (repoCount) {
        repoCount.textContent = `${visibleCount} ${visibleCount === 1 ? 'project' : 'projects'}`;
      }

      if (noResults) {
        noResults.style.display = visibleCount === 0 ? 'flex' : 'none';
      }

      // Update active badge
      if (activeCount) {
        const hasFilters = searchTerm || selectedLanguage || selectedTopic;
        activeCount.textContent = hasFilters ? 'filtered' : 'active';
      }
    }

    // Attach filter listeners
    searchInput?.addEventListener('input', filterProjects);
    languageFilter?.addEventListener('change', filterProjects);
    topicFilter?.addEventListener('change', filterProjects);

    // Reset functionality
    function resetFilters() {
      if (searchInput) searchInput.value = '';
      if (languageFilter) languageFilter.value = '';
      if (topicFilter) topicFilter.value = '';
      filterProjects();
    }

    resetButton?.addEventListener('click', resetFilters);
    clearFiltersLink?.addEventListener('click', resetFilters);

    // Initial count
    filterProjects();
  });
</script>

<style>
  .projects-page {
    max-width: 1400px;
    margin: 0 auto;
    position: relative;
  }

  /* Header - atmospheric depth with glow (matching blog) */
  .page-header {
    position: relative;
    margin-bottom: 5rem;
    padding-bottom: 3rem;
    border-bottom: 1px solid rgba(166, 182, 194, 0.08);
  }

  .header-glow {
    position: absolute;
    top: -100px;
    left: 15%;
    width: 450px;
    height: 220px;
    background: radial-gradient(
      ellipse,
      rgba(166, 182, 194, 0.15) 0%,
      rgba(132, 152, 166, 0.08) 40%,
      transparent 70%
    );
    filter: blur(60px);
    pointer-events: none;
    opacity: 0.8;
    animation: pulseGlow 8s ease-in-out infinite;
  }

  @keyframes pulseGlow {
    0%, 100% {
      opacity: 0.6;
      transform: scale(1);
    }
    50% {
      opacity: 0.9;
      transform: scale(1.1);
    }
  }

  .page-title {
    font-family: 'Cormorant Garamond', serif;
    font-size: clamp(3rem, 7vw, 5.5rem);
    font-weight: 300;
    color: var(--text-heading);
    margin: 0 0 1rem 0;
    letter-spacing: 0.02em;
    line-height: 1.1;
    text-shadow:
      0 2px 8px rgba(0, 0, 0, 0.4),
      0 4px 16px rgba(166, 182, 194, 0.1);
    position: relative;
    z-index: 1;
  }

  .page-subtitle {
    font-size: clamp(0.9375rem, 2vw, 1.125rem);
    color: var(--text-body);
    margin: 0 0 1.5rem 0;
    letter-spacing: 0.03em;
    opacity: 0.85;
    font-weight: 400;
    position: relative;
    z-index: 1;
  }

  /* Metadata - computational aesthetic (matching blog) */
  .header-meta {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.8125rem;
    color: var(--accent);
    letter-spacing: 0.02em;
    margin-bottom: 2.5rem;
    position: relative;
    z-index: 1;
  }

  .repo-count {
    font-variant-numeric: tabular-nums;
    opacity: 0.8;
  }

  .data-source {
    padding: 0.3rem 0.75rem;
    background: rgba(166, 182, 194, 0.08);
    border: 1px solid rgba(166, 182, 194, 0.15);
    border-radius: 6px;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--highlight);
    position: relative;
  }

  .data-source::before {
    content: '';
    position: absolute;
    left: -8px;
    top: 50%;
    transform: translateY(-50%);
    width: 4px;
    height: 4px;
    background: var(--highlight);
    border-radius: 50%;
    box-shadow: 0 0 8px rgba(166, 182, 194, 0.6);
    animation: pulse 2s ease-in-out infinite;
  }

  @keyframes pulse {
    0%, 100% {
      opacity: 0.4;
      transform: translateY(-50%) scale(1);
    }
    50% {
      opacity: 1;
      transform: translateY(-50%) scale(1.2);
    }
  }

  /* Filter Controls - refined atmospheric */
  .filter-controls {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr auto;
    gap: 1rem;
    position: relative;
    z-index: 1;
  }

  .search-input,
  .filter-select,
  .reset-button {
    width: 100%;
    padding: 0.875rem 1.25rem;
    background: rgba(42, 56, 68, 0.6);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(166, 182, 194, 0.2);
    border-radius: 8px;
    color: var(--text-body);
    font-size: 0.875rem;
    font-family: 'JetBrains Mono', monospace;
    transition: all var(--duration-short) var(--ease-smooth);
    outline: none;
  }

  .search-input::placeholder {
    color: var(--accent);
    opacity: 0.6;
  }

  .search-input:focus,
  .filter-select:focus {
    background: rgba(42, 56, 68, 0.75);
    border-color: rgba(166, 182, 194, 0.4);
    box-shadow: 0 0 0 3px rgba(166, 182, 194, 0.08);
  }

  .filter-select {
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23a6b6c2' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 1rem center;
    padding-right: 2.5rem;
  }

  .filter-select option {
    background: var(--base);
    color: var(--text-body);
  }

  .reset-button {
    cursor: pointer;
    white-space: nowrap;
    background: rgba(42, 56, 68, 0.7);
    border-color: rgba(166, 182, 194, 0.25);
    font-weight: 500;
  }

  .reset-button:hover {
    background: rgba(42, 56, 68, 0.85);
    border-color: rgba(166, 182, 194, 0.4);
    transform: translateY(-2px);
  }

  .reset-button:active {
    transform: translateY(0);
  }

  /* Sections - atmospheric spacing */
  .featured-section,
  .all-projects-section {
    margin-bottom: 6rem;
    position: relative;
    z-index: 1;
  }

  .section-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 3rem;
  }

  .section-title {
    font-family: 'Cormorant Garamond', serif;
    font-size: clamp(1.75rem, 3vw, 2.5rem);
    font-weight: 400;
    color: var(--text-heading);
    margin: 0;
    letter-spacing: 0.02em;
    line-height: 1.2;
  }

  .section-badge {
    padding: 0.35rem 0.875rem;
    background: rgba(166, 182, 194, 0.1);
    border: 1px solid rgba(166, 182, 194, 0.2);
    border-radius: 6px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.6875rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--accent);
    font-weight: 500;
  }

  /* Grid Layout - staggered reveal */
  .projects-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 2rem;
  }

  .featured-grid {
    grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
  }

  .grid-item {
    opacity: 0;
    transform: translateY(30px);
    filter: blur(8px);
    animation: floatIn 0.8s var(--ease-smooth) forwards;
  }

  @keyframes floatIn {
    from {
      opacity: 0;
      transform: translateY(30px);
      filter: blur(8px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
      filter: blur(0);
    }
  }

  /* Scroll-based reveal */
  .float-in {
    opacity: 0;
    transform: translateY(40px);
    filter: blur(8px);
    transition: opacity 0.8s var(--ease-smooth),
                transform 0.8s var(--ease-smooth),
                filter 0.8s var(--ease-smooth);
  }

  .float-in.is-visible {
    opacity: 1;
    transform: translateY(0);
    filter: blur(0);
  }

  /* No Results - atmospheric */
  .no-results {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 6rem 2rem;
    color: var(--text-body);
    opacity: 0.8;
  }

  .no-results p {
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.5rem;
    margin-bottom: 1.5rem;
    color: var(--text-heading);
  }

  .reset-link {
    color: var(--text-body);
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.875rem;
    cursor: pointer;
    background: rgba(42, 56, 68, 0.6);
    border: 1px solid rgba(166, 182, 194, 0.2);
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    transition: all var(--duration-short) var(--ease-smooth);
  }

  .reset-link:hover {
    background: rgba(42, 56, 68, 0.8);
    border-color: rgba(166, 182, 194, 0.35);
    color: var(--text-heading);
    transform: translateY(-2px);
  }

  /* Responsive */
  @media (max-width: 1024px) {
    .page-header {
      margin-bottom: 4rem;
      padding-bottom: 2.5rem;
    }

    .header-glow {
      width: 300px;
      height: 150px;
    }

    .filter-controls {
      grid-template-columns: 1fr 1fr;
    }

    .search-input {
      grid-column: 1 / -1;
    }

    .reset-button {
      grid-column: 1 / -1;
    }
  }

  @media (max-width: 768px) {
    .page-header {
      margin-bottom: 3rem;
      padding-bottom: 2rem;
    }

    .header-glow {
      width: 200px;
      height: 100px;
      top: -60px;
    }

    .page-title {
      font-size: 2.5rem;
    }

    .page-subtitle {
      font-size: 0.875rem;
    }

    .header-meta {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.75rem;
      margin-bottom: 2rem;
    }

    .filter-controls {
      grid-template-columns: 1fr;
    }

    .projects-grid,
    .featured-grid {
      grid-template-columns: 1fr;
      gap: 1.5rem;
    }

    .featured-section,
    .all-projects-section {
      margin-bottom: 4rem;
    }

    .section-header {
      margin-bottom: 2rem;
    }
  }

  /* Reduce motion for accessibility */
  @media (prefers-reduced-motion: reduce) {
    .header-glow {
      animation: none;
      opacity: 0.6;
    }

    .data-source::before {
      animation: none;
      opacity: 0.8;
    }

    .grid-item {
      animation: none;
      opacity: 1;
      transform: none;
      filter: none;
    }

    .float-in {
      transition: none;
    }
  }
</style>
