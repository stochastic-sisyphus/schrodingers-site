---
/**
 * Research publications overview page
 */

import ContentLayout from '@/layouts/ContentLayout.astro';
import { getCollection } from 'astro:content';
import { fetchAllResearchData } from '@/lib/orcid';
import ResearchCard from '@/components/ResearchCard.astro';
import PublicationTimeline from '@/components/visualizations/PublicationTimeline.svelte';

// Fetch from both sources
const localPapers = await getCollection('research');
const orcidData = await fetchAllResearchData().catch(() => ({
  profile: null,
  papers: [],
}));

// Combine and sort by year
const allPapers = [
  ...localPapers.map(paper => ({
    id: paper.slug,
    title: paper.data.title,
    authors: paper.data.authors,
    year: paper.data.year,
    journal: paper.data.journal,
    doi: paper.data.doi,
    orcidUrl: paper.data.orcidUrl,
    abstract: paper.data.abstract,
    type: paper.data.type,
    isLocal: true,
  })),
  ...orcidData.papers.map(paper => ({
    ...paper,
    isLocal: false,
  })),
].sort((a, b) => b.year - a.year);

// Group by year
const papersByYear = allPapers.reduce((acc, paper) => {
  if (!acc[paper.year]) {
    acc[paper.year] = [];
  }
  acc[paper.year].push(paper);
  return acc;
}, {} as Record<number, typeof allPapers>);

const years = Object.keys(papersByYear)
  .map(Number)
  .sort((a, b) => b - a);
---

<ContentLayout
  title="Research | stochastic-sisyphus"
  description="Academic publications and research contributions in computational science, data analysis, and systems thinking."
>
  <article class="research-list">
    <h1 class="page-title">research</h1>

    <div class="orcid-link frosted-glass">
      <a
        href="https://orcid.org/0009-0008-6611-535X"
        target="_blank"
        rel="noopener noreferrer"
      >
        View ORCID Profile â†’
      </a>
    </div>

    {allPapers.length > 0 && (
      <div class="visualization-section frosted-glass">
        <PublicationTimeline
          client:load
          publications={allPapers.map(p => ({
            id: p.id,
            title: p.title,
            year: p.year,
            type: p.type,
            journal: p.journal
          }))}
        />
      </div>
    )}

    <div class="timeline">
      {years.map((year) => (
        <div class="year-group">
          <h2 class="year-label">{year}</h2>

          <div class="papers-list">
            {papersByYear[year].map((paper) => (
              <ResearchCard
                id={paper.id}
                title={paper.title}
                authors={paper.authors}
                year={paper.year}
                journal={paper.journal}
                doi={paper.doi}
                orcidUrl={paper.orcidUrl}
                abstract={paper.abstract}
                type={paper.type}
                isLocal={paper.isLocal}
              />
            ))}
          </div>
        </div>
      ))}
    </div>

    {allPapers.length === 0 && (
      <p class="no-papers">No publications yet.</p>
    )}
  </article>
</ContentLayout>

<style>
  .research-list {
    max-width: 900px;
    margin: 0 auto;
  }

  .page-title {
    font-family: 'Cormorant Garamond', serif;
    font-size: clamp(48px, 6vw, 72px);
    font-weight: 300;
    color: var(--highlight);
    margin: 0 0 2rem 0;
    letter-spacing: 0.02em;
  }

  .orcid-link {
    background: rgba(68, 88, 104, 0.1);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(166, 182, 194, 0.2);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 4rem;
    text-align: center;
  }

  .orcid-link a {
    color: var(--accent);
    text-decoration: none;
    font-size: 1.0625rem;
    transition: color 0.2s ease;
  }

  .orcid-link a:hover {
    color: var(--highlight);
  }

  .visualization-section {
    background: rgba(68, 88, 104, 0.1);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(166, 182, 194, 0.2);
    border-radius: 12px;
    padding: 2rem;
    margin-bottom: 4rem;
    min-height: 400px;
  }

  .timeline {
    display: flex;
    flex-direction: column;
    gap: 4rem;
  }

  .year-group {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .year-label {
    font-family: 'Cormorant Garamond', serif;
    font-size: 2rem;
    font-weight: 500;
    color: var(--accent);
    margin: 0;
    letter-spacing: 0.02em;
  }

  .papers-list {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .no-papers {
    text-align: center;
    color: var(--light);
    font-size: 1.125rem;
    padding: 4rem 0;
  }

  @media (max-width: 768px) {
    .visualization-section {
      padding: 1rem;
      margin-bottom: 3rem;
      min-height: 300px;
    }

    .timeline {
      gap: 3rem;
    }
  }
</style>
