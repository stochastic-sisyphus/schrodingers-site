---
/**
 * Research publications overview page
 * Atmospheric depth - living research networks, not static paper list
 */

import ContentLayout from '@/layouts/ContentLayout.astro';
import SEO from '@/components/SEO.astro';
import Navigation from '@/components/Navigation.astro';
import { getCollection } from 'astro:content';
import { fetchAllResearchData } from '@/lib/orcid';
import ResearchCard from '@/components/ResearchCard.astro';
import Footer from '@/components/Footer.astro';

// Fetch from both sources
const localPapers = await getCollection('research');
const orcidData = await fetchAllResearchData().catch(() => ({
  profile: null,
  papers: [],
}));

// Combine and sort by year
const allPapers = [
  ...localPapers.map(paper => ({
    id: paper.slug,
    title: paper.data.title,
    authors: paper.data.authors,
    year: paper.data.year,
    journal: paper.data.journal,
    doi: paper.data.doi,
    orcidUrl: paper.data.orcidUrl,
    abstract: paper.data.abstract,
    type: paper.data.type,
    isLocal: true,
  })),
  ...orcidData.papers.map(paper => ({
    ...paper,
    isLocal: false,
  })),
].sort((a, b) => b.year - a.year);

// Group by year
const papersByYear = allPapers.reduce((acc, paper) => {
  if (!acc[paper.year]) {
    acc[paper.year] = [];
  }
  acc[paper.year].push(paper);
  return acc;
}, {} as Record<number, typeof allPapers>);

const years = Object.keys(papersByYear)
  .map(Number)
  .sort((a, b) => b - a);
---

<ContentLayout
  title="Research | stochastic-sisyphus"
  description="Academic publications and research contributions in computational science, data analysis, and systems thinking."
>
  <SEO
    slot="head"
    title="Research"
    description="Publications and research papers"
    canonical={Astro.url.href}
  />

  <Navigation />

  <article class="research-page">
    <!-- Header with atmospheric depth -->
    <header class="page-header">
      <div class="header-glow" aria-hidden="true"></div>
      <h1 class="page-title">research</h1>
      <p class="page-subtitle">
        Academic publications & computational research
      </p>
      <div class="header-meta">
        <span class="paper-count">{allPapers.length} publications</span>
        <span class="data-source">orcid api</span>
        <a
          href="https://orcid.org/0009-0008-6611-535X"
          target="_blank"
          rel="noopener noreferrer"
          class="orcid-badge"
        >
          orcid profile â†’
        </a>
      </div>
    </header>

    <!-- Timeline with staggered reveals -->
    <div class="timeline">
      {years.map((year, yearIndex) => (
        <section class="year-group float-in" style={`animation-delay: ${yearIndex * 0.15}s`}>
          <div class="year-header">
            <h2 class="year-label">{year}</h2>
            <span class="year-count">{papersByYear[year].length}</span>
          </div>

          <div class="papers-list">
            {papersByYear[year].map((paper, paperIndex) => (
              <div class="paper-item" style={`animation-delay: ${(yearIndex * 0.15) + (paperIndex * 0.1)}s`}>
                <ResearchCard
                  id={paper.id}
                  title={paper.title}
                  authors={paper.authors}
                  year={paper.year}
                  journal={paper.journal}
                  doi={paper.doi}
                  orcidUrl={paper.orcidUrl}
                  abstract={paper.abstract}
                  type={paper.type}
                  isLocal={paper.isLocal}
                />
              </div>
            ))}
          </div>
        </section>
      ))}
    </div>

    {allPapers.length === 0 && (
      <div class="no-papers">
        <p>No publications yet</p>
      </div>
    )}
  </article>

  <Footer slot="footer" />
</ContentLayout>

<script>
  // Atmospheric reveal on scroll
  import { initScrollAnimations } from '@/lib/scroll-animations';

  document.addEventListener('DOMContentLoaded', () => {
    initScrollAnimations('.float-in');
  });
</script>

<style>
  .research-page {
    max-width: 1100px;
    margin: 0 auto;
    position: relative;
  }

  /* Header - atmospheric depth with glow (matching blog/projects) */
  .page-header {
    position: relative;
    margin-bottom: 5rem;
    padding-bottom: 3rem;
    border-bottom: 1px solid rgba(166, 182, 194, 0.08);
  }

  .header-glow {
    position: absolute;
    top: -100px;
    left: 12%;
    width: 420px;
    height: 210px;
    background: radial-gradient(
      ellipse,
      rgba(166, 182, 194, 0.14) 0%,
      rgba(132, 152, 166, 0.07) 40%,
      transparent 70%
    );
    filter: blur(60px);
    pointer-events: none;
    opacity: 0.8;
    animation: pulseGlow 8s ease-in-out infinite;
  }

  @keyframes pulseGlow {
    0%, 100% {
      opacity: 0.6;
      transform: scale(1);
    }
    50% {
      opacity: 0.9;
      transform: scale(1.1);
    }
  }

  .page-title {
    font-family: 'Cormorant Garamond', serif;
    font-size: clamp(3rem, 7vw, 5.5rem);
    font-weight: 300;
    color: var(--text-heading);
    margin: 0 0 1rem 0;
    letter-spacing: 0.02em;
    line-height: 1.1;
    text-shadow:
      0 2px 8px rgba(0, 0, 0, 0.4),
      0 4px 16px rgba(166, 182, 194, 0.1);
    position: relative;
    z-index: 1;
  }

  .page-subtitle {
    font-size: clamp(0.9375rem, 2vw, 1.125rem);
    color: var(--text-body);
    margin: 0 0 1.5rem 0;
    letter-spacing: 0.03em;
    opacity: 0.85;
    font-weight: 400;
    position: relative;
    z-index: 1;
  }

  /* Metadata - computational aesthetic (matching blog/projects) */
  .header-meta {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 1.5rem;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.8125rem;
    color: var(--accent);
    letter-spacing: 0.02em;
    position: relative;
    z-index: 1;
  }

  .paper-count {
    font-variant-numeric: tabular-nums;
    opacity: 0.8;
  }

  .data-source {
    padding: 0.3rem 0.75rem;
    background: rgba(166, 182, 194, 0.08);
    border: 1px solid rgba(166, 182, 194, 0.15);
    border-radius: 6px;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--highlight);
    position: relative;
  }

  .data-source::before {
    content: '';
    position: absolute;
    left: -8px;
    top: 50%;
    transform: translateY(-50%);
    width: 4px;
    height: 4px;
    background: var(--highlight);
    border-radius: 50%;
    box-shadow: 0 0 8px rgba(166, 182, 194, 0.6);
    animation: pulse 2s ease-in-out infinite;
  }

  @keyframes pulse {
    0%, 100% {
      opacity: 0.4;
      transform: translateY(-50%) scale(1);
    }
    50% {
      opacity: 1;
      transform: translateY(-50%) scale(1.2);
    }
  }

  .orcid-badge {
    padding: 0.3rem 0.75rem;
    background: rgba(166, 182, 194, 0.08);
    border: 1px solid rgba(166, 182, 194, 0.15);
    border-radius: 6px;
    font-size: 0.75rem;
    text-transform: lowercase;
    letter-spacing: 0.02em;
    color: var(--highlight);
    text-decoration: none;
    transition: all var(--duration-short) var(--ease-smooth);
  }

  .orcid-badge:hover {
    background: rgba(166, 182, 194, 0.12);
    border-color: rgba(166, 182, 194, 0.25);
    color: var(--text-heading);
    transform: translateY(-2px);
  }

  /* Timeline - atmospheric spacing */
  .timeline {
    display: flex;
    flex-direction: column;
    gap: 5rem;
    position: relative;
    z-index: 1;
  }

  .year-group {
    position: relative;
  }

  .year-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 2.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid rgba(166, 182, 194, 0.08);
  }

  .year-label {
    font-family: 'Cormorant Garamond', serif;
    font-size: clamp(1.875rem, 3vw, 2.75rem);
    font-weight: 400;
    color: var(--text-heading);
    margin: 0;
    letter-spacing: 0.02em;
    line-height: 1.2;
  }

  .year-count {
    padding: 0.35rem 0.875rem;
    background: rgba(166, 182, 194, 0.1);
    border: 1px solid rgba(166, 182, 194, 0.2);
    border-radius: 6px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.75rem;
    color: var(--accent);
    font-variant-numeric: tabular-nums;
  }

  .papers-list {
    display: flex;
    flex-direction: column;
    gap: 2rem;
  }

  .paper-item {
    opacity: 0;
    transform: translateY(30px);
    filter: blur(8px);
    animation: floatIn 0.8s var(--ease-smooth) forwards;
  }

  @keyframes floatIn {
    from {
      opacity: 0;
      transform: translateY(30px);
      filter: blur(8px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
      filter: blur(0);
    }
  }

  /* Scroll-based reveal */
  .float-in {
    opacity: 0;
    transform: translateY(40px);
    filter: blur(8px);
    transition: opacity 0.8s var(--ease-smooth),
                transform 0.8s var(--ease-smooth),
                filter 0.8s var(--ease-smooth);
  }

  .float-in.is-visible {
    opacity: 1;
    transform: translateY(0);
    filter: blur(0);
  }

  /* No papers state - atmospheric */
  .no-papers {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 6rem 2rem;
    color: var(--text-body);
    opacity: 0.8;
  }

  .no-papers p {
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.5rem;
    margin: 0;
    color: var(--text-heading);
  }

  /* Responsive adjustments */
  @media (max-width: 1024px) {
    .page-header {
      margin-bottom: 4rem;
      padding-bottom: 2.5rem;
    }

    .header-glow {
      width: 300px;
      height: 150px;
    }

    .timeline {
      gap: 4rem;
    }
  }

  @media (max-width: 768px) {
    .page-header {
      margin-bottom: 3rem;
      padding-bottom: 2rem;
    }

    .header-glow {
      width: 200px;
      height: 100px;
      top: -60px;
    }

    .page-title {
      font-size: 2.5rem;
    }

    .page-subtitle {
      font-size: 0.875rem;
    }

    .header-meta {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.75rem;
    }

    .timeline {
      gap: 3rem;
    }

    .year-header {
      margin-bottom: 2rem;
    }

    .papers-list {
      gap: 1.5rem;
    }
  }

  /* Reduce motion for accessibility */
  @media (prefers-reduced-motion: reduce) {
    .header-glow {
      animation: none;
      opacity: 0.6;
    }

    .data-source::before {
      animation: none;
      opacity: 0.8;
    }

    .paper-item {
      animation: none;
      opacity: 1;
      transform: none;
      filter: none;
    }

    .float-in {
      transition: none;
    }
  }
</style>
